
<style>
	/*auto*/
	.users .name { font-size: 12px; font-weight: bold; }
	.users .name b { color: #68A754; }
	.users .position { font-size: 11px; }
	.users .item { line-height: 12px; font-size: 12px; padding: 5px 5px 5px 0; cursor: pointer; border-bottom: 1px solid #E0E0E0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
	.users .item .fa-circle { font-size: 8px; }
	.users .item:hover { background-color: #2E5ADA; color: white; }
	.users .selected { background-color: #2E5ADA; color: white; }
	.userphoto { background-color: #F0F0F0; padding: 24px 0; }
	.userphoto img { max-width: 130px; }

	.ui-directory-container { height: 120px; }
	.si { width: 24px; text-align: center; border-right: 1px solid rgba(200,200,200,0.3); margin-right: 4px; }

	@media(max-width: 767px) {
		.users .item { font-size: 14px; padding: 8px; line-height: 14px; }
	}

	.m { margin-bottom: 20px; }

	.userapp-container { border-bottom: 1px solid #F0F0F0; margin-bottom: 10px; background-color: white; padding-bottom: 5px; }
	.userapp-container:last-child { border-bottom: 0; margin-bottom: 0; }
	.userapp-container-disabled img { filter: grayscale(100%); }
	.userapp-container-disabled .usersapp-info { display: none; }
	.userapp-container-disabled .userapp-settings { display: none; }
	.userapp-container-disabled { color: #A0A0A0; padding-bottom: 0; }
	.userapp-container-disabled .userapp-roles { display: none; }
	.userapp-checkbox { float: left; width: 30px; height: 30px; background-color: #8CC152; margin-right: 10px; border-radius: 4px; border: 2px solid #8CC152; cursor: pointer; color: white; line-height: 28px; text-align: center; font-size: 20px; }
	.userapp-container-disabled .userapp-checkbox .fa { display: none; }
	.userapp-container-disabled .userapp-checkbox { background-color: white; border-color: #E0E0E0; }
	.userapp-header > .fa { margin-right: 5px; }
	.userapp-header { height: 40px; line-height: 15px; }
	.userapp-roles { margin-bottom: 10px; line-height: 0; }
	.userapp-roles div { width: 33.3%; position: relative; display: inline-block; background-color: #F0F0F0; padding: 5px 10px; font-size: 11px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
	.userapp-roles label { cursor: pointer; }
	.userapp-roles div:nth-child(odd) { background-color: #F8F8F8; }
	.userapp-roles input { margin-right: 5px; vertical-align: middle; }
	.userapp-settings input { background-color: white; border: 1px solid #E0E0E0; padding: 5px 8px; border-radius: 2px; width: 100%; font-size: 11px; outline: 0; appearance: none; }
	.userapp-settings { margin-bottom: 5px; }
	.userapp-version { font-size: 11px; }
	.usersapp-info { font-size: 10px; color: #A0A0A0; margin-top: 5px; margin-bottom: 5px; }
	.customer { float: right; font-size: 9px; color: gray; margin: 1px 0 0; }
	@{if user.colorscheme}
	.ui-checkbox-checked div{background-color:@{user.colorscheme}!important;border-color:@{user.colorscheme}!important}
	.button{background-color:@{user.colorscheme}}
	.users .selected,.users .item:hover{background-color:@{user.colorscheme}}
	.users .selected,.users .item:hover .customer, .users .selected .customer { color: white; }
	@{fi}

</style>

<div class="row">
	<div class="col-sm-3 np">
		<div class="panel">
			<div class="search">
				<div data---="textbox__users.filter.q__type:search;placeholder:@(Search users)"></div>
			</div>
			<div data---="scrollbar__users.items__margin:40;parent:window;offset:true">
				<div data---="listmenu__users.selected__datasource:users.items;selector:.item;exec:usersform_load" class="users">
					<script type="text/html">
						<div class="item{{ if blocked || inactive }} inactive{{ fi }}" data-search="{{ lastname }} {{ firstname }}">{{ if customer }}<i class="fa fa-user-secret customer" title="@(Customer)"></i>{{ fi }}{{ statusid | status(true) }}{{ lastname }} {{ firstname }}{{ if online }} <i class="fa fa-circle green"></i>{{ fi }}</div>
					</script>
				</div>
			</div>
			<nav class="toolbar">
				<button class="exec" data-exec="userform_create" title="@(Add user)"><i class="fa fa-plus"></i></button>
				<button data-bind="users.selected__disabled:!value" class="exec" data-exec="usersform_remove" title="@(Remove user)"><i class="fa fa-minus"></i></button>
				<button data-bind="common.isfilter__.red" class="exec" data-exec="userform_filter" title="@(Filter)"><i class="fa fa-filter"></i></button>
				<button data-bind="users.response__enabled:users_pagination" name="prev" class="exec" data-exec="users_page" title="@(Previous page)"><i class="fa fa-chevron-left"></i></button>
				<button data-bind="users.response__enabled:users_pagination" name="next" class="exec" data-exec="users_page" title="@(Next page)" style="border-right:0"><i class="fa fa-chevron-right"></i></button>
			</nav>
		</div>
	</div>
	<div class="col-sm-9 np" data---="xs__users.form.show__if:value!=null&&value==true;exec:resizelayout">
		<nav class="nav visible-xs">
			<span class="link exec" data-exec="userform_cancel"><i class="fa fa-chevron-left"></i>@(Back)</span>
		</nav>
		<div class="invisible" data-bind="users.form.show__visible__exec:formscroll">
			<div data---="scrollbar__users.form.show__margin:40;parent:window;marginxs:42">
				<div class="userphoto">
					<div data---="preview__users.form.photo__url:/api/upload/photo/;width:300;height:300;format:/photos/{0}"></div>
					<div class="help center"><i class="fa fa-camera"></i>@(300x300 pixels)</div>
				</div>
				<div data-bind="users.form__track:id__template">
					<script type="text/html">
						{{ if value.id }}
							<div class="scroller-padding">
								<table class="table table-bordered table-small nmb bg-white">
									<tbody>
										<tr>
											<td class="bg-smoke">@(ID)</td>
											<td class="col-xs-6 right">{{ value.id }}</td>
										</tr>
										{{ if value.dtlogged }}
										<tr>
											<td class="bg-smoke">@(Logged)</td>
											<td class="right">{{ if value.online }}<span class="badge badge-green mr5">@(online)</span>{{ fi }}{{ value.dtlogged | format('@(yyyy-MM-dd HH:mm)') }}</td>
										</tr>
										{{ fi }}
										{{ if value.dtcreated }}
										<tr>
											<td class="bg-smoke">@(Created)</td>
											<td class="right">{{ value.dtcreated | format('@(yyyy-MM-dd HH:mm)') }}</td>
										</tr>
										{{ fi }}
										{{ if value.dtmodified }}
										<tr>
											<td class="bg-smoke">@(Updated)</td>
											<td class="right">{{ value.dtmodified | format('@(yyyy-MM-dd HH:mm)') }}</td>
										</tr>
										{{ fi }}
										{{ if value.dtpassword }}
										<tr>
											<td class="bg-smoke">@(Password changed)</td>
											<td class="right">{{ value.dtpassword | format('@(yyyy-MM-dd HH:mm)') }}</td>
										</tr>
										{{ fi }}
										{{ if value.dtnotified }}
										<tr>
											<td class="bg-smoke">@(Last notification)</td>
											<td class="right">{{ value.dtnotified | format('@(yyyy-MM-dd HH:mm)') }}</td>
										</tr>
										{{ fi }}
										{{ if value.countnotifications }}
										<tr>
											<td class="bg-smoke">@(Undread notifications)</td>
											<td class="right">{{ value.countnotifications }}x</td>
										</tr>
										{{ fi }}
										{{ if value.countsessions }}
										<tr>
											<td class="bg-smoke">@(Open sessions)</td>
											<td class="right">{{ value.countsessions }}x</td>
										</tr>
										{{ fi }}
									</tbody>
								</table>
							</div>
							<hr class="nmb nmt" />
						{{ fi }}
					</script>
				</div>
				<div class="scroller-padding npb">
					<div class="row">
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.firstname__maxlength:50;required:true;$id:firstinput">@(First name)</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.lastname__maxlength:50;required:true">@(Last name)</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.email__icon2:envelope;maxlength:120;required:true;type:email__'@'">@(Email address)</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.phone__icon2:phone;maxlength:30;type:phone">@(Phone number)</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6 m">
							<div data---="dropdown__users.form.statusid__items:@(Available|0,Busy|1,Do not disturb|2,Be right back|3,Meeting|4,Business trip|5,Holiday|6,Sick|7,Off work|8);type:number__0">@(Status)</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.status__maxlength:70">@(Status note)</div>
						</div>
					</div>
				</div>
				<hr />
				<div class="scroller-padding">
					<div class="row">
						<div class="col-sm-4 m">
							<div data---="dropdown__users.form.language__empty:;icon:language;items:Abkhaz|ab,Afar|aa,Afrikaans|af,Akan|ak,Albanian|sq,Amharic|am,Arabic|ar,Aragonese|an,Armenian|hy,Assamese|as,Avaric|av,Avestan|ae,Aymara|ay,Azerbaijani|az,Bambara|bm,Bashkir|ba,Basque|eu,Belarusian|be,Bengali|bn,Bihari|bh,Bislama|bi,Bosnian|bs,Breton|br,Bulgarian|bg,Burmese|my,Catalan|ca,Chamorro|ch,Chechen|ce,Chichewa|ny,Chinese|zh,Church Slavic|cu,Chuvash|cv,Cornish|kw,Corsican|co,Cree|cr,Croatian|hr,Czech|cs,Danish|da,Divehi|dv,Dutch|nl,Dzongkha|dz,English|en,Esperanto|eo,Estonian|et,Ewe|ee,Faroese|fo,Fijian|fj,Finnish|fi,French|fr,Fulah|ff,Gaelic|gd,Galician|gl,Ganda|lg,Georgian|ka,German|de,Greek|el,Guaraní|gn,Gujarati|gu,Haitian|ht,Hausa|ha,Hebrew|he,Herero|hz,Hindi|hi,Hiri Motu|ho,Hungarian|hu,Icelandic|is,Ido|io,Igbo|ig,Indonesian|id,Interlingua|ia,Interlingue|ie,Inuktitut|iu,Inupiaq|ik,Irish|ga,Italian|it,Japanese|ja,Javanese|jv,Kalaallisut|kl,Kannada|kn,Kanuri|kr,Kashmiri|ks,Kazakh|kk,Khmer|km,Kikuyu|ki,Kinyarwanda|rw,Kirghiz|ky,Kirundi|rn,Komi|kv,Kongo|kg,Korean|ko,Kuanyama|kj,Kurdish|ku,Lao|lo,latin|la,Latvian|lv,Limburgish|li,Lingala|ln,Lithuanian|lt,Luba-Katanga|lu,Luxembourgish|lb,Macedonian|mk,Malagasy|mg,Malay|ms,Malayalam|ml,Maltese|mt,Manx|gv,Māori|mi,Marathi|mr,Marshallese|mh,Moldavian|mo,Mongolian|mn,Nauru|na,Navajo|nv,Ndonga|ng,Nepali|ne,Northern Sami|se,North Ndebele|nd,Norwegian|no,Norwegian Bokmål|nb,Norwegian Nynorsk|nn,Occitan|oc,Ojibwa|oj,Oriya|or,Oromo|om,Ossetian|os,Pāli|pi,Panjabi|pa,Pashto|ps,Persian|fa,Polish|pl,Portuguese|pt,Quechua|qu,Raeto-Romance|rm,Romanian|ro,Russian|ru,Samoan|sm,Sango|sg,Sanskrit|sa,Sardinian|sc,Serbian|sr,Serbo-Croatian|sh,Shona|sn,Sichuan Yi|ii,Sindhi|sd,Sinhala|si,Slovak|sk,Slovenian|sl,Somali|so,Southern Sotho|st,South Ndebele|nr,Spanish|es,Sundanese|su,Swahili|sw,Swati|ss,Swedish|sv,Tagalog|tl,Tahitian|ty,Tajik|tg,Tamil|ta,Tatar|tt,Telugu|te,Thai|th,Tibetan|bo,Tigrinya|ti,Tonga|to,Tsonga|ts,Tswana|tn,Turkish|tr,Turkmen|tk,Twi|tw,Uighur|ug,Ukrainian|uk,Urdu|ur,Uzbek|uz,Venda|ve,Vietnamese|vi,Volapük|vo,Walloon|wa,Welsh|cy,Western Frisian|fy,Wolof|wo,Xhosa|xh,Yiddish|yi,Yoruba|yo,Zhuang|za,Zulu|zu">@(Language)</div>
						</div>
						<div class="col-sm-4 m">
							<div data---="dropdown__users.form.gender__items:@(male)|male,@(female)|female">@(Gender)</div>
						</div>
						<div class="col-sm-4 m">
							<div data---="textbox__users.form.reference__align:center">@(Custom reference)</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4 m">
							<div data---="textbox__users.form.dtbirth__placeholder:@(yyyy-mm-dd);delay:2000;type:date;maxlength:10;align:center;format:@(yyyy-MM-dd)">@(Date of birth)</div>
						</div>
						<div class="col-sm-4 m">
							<div data---="textbox__users.form.dtbeg__placeholder:@(yyyy-mm-dd);delay:2000;type:date;maxlength:10;align:center;format:@(yyyy-MM-dd)">@(Date of start)</div>
						</div>
						<div class="col-sm-4 m">
							<div data---="textbox__users.form.dtend__placeholder:@(yyyy-mm-dd);delay:2000;type:date;maxlength:10;align:center;format:@(yyyy-MM-dd)">@(Date of end)</div>
						</div>
					</div>
					<hr />
					<div class="row">
						<div class="col-sm-4 m">
							<div data---="dropdown__users.form.dateformat__datasource:dateformats__1">@(Date format)</div>
						</div>
						<div class="col-sm-4 m">
							<div data---="dropdown__users.form.timeformat__items:@(24 hour clock)|24,@(12 hour clock)|12;type:number__24">@(Time)</div>
						</div>
						<div class="col-sm-4 m">
							<div data---="dropdown__users.form.numberformat__datasource:numberformats;type:number__1">@(Number format)</div>
						</div>
					</div>
				</div>

				<div class="scroller-padding bg-smoke npb">

					<div class="alert m">
						<i class="fa fa-warning mr5"></i><b>@(IMPORTANT):</b>
						<div class="mt5">@(Directory can restrict OpenPlatform API for obtaining of users according to <b>Directory</b> except of administrators. We don't recommend use numbers.)</div>
					</div>

					<div class="row" data-bind="user.directory__config [data-jc]:'disabled:' + (!!value)">
						<div class="col-sm-6 m">
							<div data---="dropdown__users.form.directory__empty:;datasource:users.meta.directories;icon:folder;value:name">@(Select existing Directory)</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.directory__maxlength:25;type:lower">@(Directory)</div>
						</div>
					</div>
				</div>

				<div class="scroller-padding npb">

					<div class="row">
						<div class="col-sm-6 m">
							<div data---="dropdown__users.form.ou__empty:;datasource:users.meta.ou;value:name">@(Select existing Organization unit)</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.ou__maxlength:100">@(Organization unit)</div>
							<div class="help">@(For example <code>Developers / Node.js</code>)</div>
						</div>
					</div>
				</div>
				<hr class="nmt nmb" />
				<div class="scroller-padding">
					<div class="row">
						<div class="col-sm-6 m">
							<div data---="dropdown__users.form.locality__empty:;datasource:users.meta.localities;icon:map-marker;value:name">@(Select existing Locality)</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.locality__maxlength:40">@(Locality)</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6 m">
							<div data---="dropdown__users.form.position__empty:;datasource:users.meta.positions;icon:suitcase;value:name">@(Select existing Position)</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.position__maxlength:40">@(Position)</div>
						</div>
					</div>
				</div>
				<hr class="nmt nmb" />
				<div class="scroller-padding">
					<div class="row">
						<div class="col-sm-6 m">
							<div data---="dynamicvalue__users.form.supervisorid__url:/api/internal/users/{value}/;click:userform_search;placeholder:@(Choose a user)">@(Select <b>Supervisor</b>)</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="dynamicvalue__users.form.deputyid__url:/api/internal/users/{value}/;click:userform_search;placeholder:@(Choose a user)">@(Select <b>Deputy</b>)</div>
						</div>
					</div>
				</div>
				<div class="scroller-padding bg-smoke npb">
					<div class="row">
						<div class="col-sm-6 m">
							<div data---="dropdown__users.form.company__empty:;datasource:users.meta.companies;icon:building;value:name">@(Select existing Company)</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.company__maxlength:40">@(Company)</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6 m">
							<div class="alert">
								<i class="fa fa-info-circle mr5"></i>@(<b>Group ID</b> is suitable for pairing of users from the same company or group.)
							</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.groupid__maxlength:30;placeholder:@(Some identificator)">@(Group ID)</div>
						</div>
					</div>
				</div>
				<div class="scroller-padding">
					<div class="row">
						<div class="col-sm-6">
							<div class="mt10 b red" data---="checkbox__users.form.blocked">@(User is blocked)</div>
							<div class="red" data---="checkbox__users.form.inactive">@(User is inactive)</div>
							<div data---="checkbox__users.form.customer">@(User is customer)</div>
							<div data---="checkbox__users.form.sa">@(User is <b>administrator</b>)</div>
							<div data---="checkbox__users.form.welcome">@(Send welcome email)</div>
						</div>
						<div class="col-sm-6">
							<div class="mt10" data---="checkbox__users.form.sounds">@(Enable sounds)</div>
							<div data---="checkbox__users.form.notifications">@(Enable notifications)</div>
							<div data---="checkbox__users.form.notificationsemail">@(Enable email notifications)</div>
							<div data---="checkbox__users.form.notificationsphone">@(Enable phone notifications)</div>
							<div data-bind="users.form.id__show" class="hidden">
								<div data---="checkbox__users.form.rebuildaccesstoken" class="b">@(Re-build access token)</div>
								<div data---="checkbox__users.form.rebuildtoken" class="b">@(Re-build verification token)</div>
							</div>
						</div>
					</div>
					<br />
					<div data---="range__users.form.volume__icon:volume-up;min:10;max:100;type:number">@(Volume)</div>
					<div class="row fs11 silver">
						<div class="col-xs-6">
							@(Low)
						</div>
						<div class="col-xs-6 right">
							@(High)
						</div>
					</div>
					<hr />
					<div class="help" style="margin-top:30px"><i class="fa fa-info-circle"></i>@(User can change the password if is logged.)</div>
					<br />
					<div class="row">
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.login__icon2:user;maxlength:120;required:true">@(Login name)</div>
							<div class="help"><i class="fa fa-envelope"></i>@(Login name can be an email address.)</div>
						</div>
						<div class="col-sm-6 m">
							<div data---="textbox__users.form.password__icon2:lock;maxlength:30;required:true;type:password">@(Password)</div>
							<div class="help"><span class="exec link" data-exec="userform_generatepassword">@(Generate password)</span></div>
						</div>
					</div>
					<hr />
					<h2><i class="fa fa-sitemap"></i>@(Custom roles)</h2>
					<div class="fs12 red"><i class="fa fa-warning mr5"></i><b>@(IMPORTANT:)</b> @(Each application inherits these custom roles.)</div>
					<div data---="textboxlist__users.form.roles__placeholder:@(Type a global role and press enter)" class="mt10"></div>
					<div class="help m"><span class="link exec" data-exec="browseroles"><i class="fa fa-search"></i>@(Browse roles)</span></div>
					<h2><i class="fa fa-sitemap"></i>@(Custom groups)</h2>
					<div data---="textboxlist__users.form.groups__placeholder:@(Type a group name and press enter)"></div>
					<div class="help m"><span class="link exec" data-exec="browsegroups"><i class="fa fa-search"></i>@(Browse groups)</span></div>
					<hr />
					<h2 class="nmb"><i class="fa fa-th"></i>@(Applications)</h2>
					<div class="help">@(Enable access into the applications below for this user. Each application can have a specific permissions and the permissions are visibled when you allow the application.)</div>
					<br />
					<div data---="app-managment__users.form.apps__datasource:users.apps.items" class="m">
						<script type="text/html">
							<div class="userapp-container userapp-container-disabled" data-id="{{ id }}">
								<div class="userapp-header">
									<div class="userapp-checkbox"><i class="fa fa-check"></i></div>
									<i class="fa fa-{{ icon }}"></i><b>{{ title }}</b>
									<div class="userapp-version">v{{ version }}</div>
								</div>
								{{ if roles && roles.length }}
								<div class="userapp-roles">
									{{ foreach m in roles }}
										<div><label><input type="checkbox" value="{{ m }}" />{{ m }}</label></div>
									{{ end }}
								</div>
								{{ fi }}
								<div class="userapp-settings">
									<input type="text" maxlength="100" class="userapp-settings-input" data-id="{{ id }}" placeholder="@(Custom settings for the application)" />
								</div>
								<div class="usersapp-info">@(Version:) <span class="userapp-user-version"></span> / @(Notifications:) <span class="userapp-user-notifications"></span> / @(Badges:) <span class="userapp-user-badges"></span></div>
							</div>
						</script>
					</div>
					<div data---="error__users.form.response"></div>
				</div>
			</div>
			<div class="buttonbar" data---="validation__users.form">
				<button name="submit" class="button exec b" data-exec="userform_submit" disabled="disabled"><i class="fa fa-floppy-o"></i>@(SUBMIT)</button>
			</div>
		</div>

	</div>

</div>

@{json(user, 'userdata')}

<script>

	var user = PARSE('#userdata');
	var users = {};
	users.form = {};
	users.filter = { page: 1, limit: 100 };
	users.items = EMPTYARRAY;

	var numberformats = [{ id: 1, name: '100 000.123' }, { id: 2, name: '100 000,123' }, { id: 3, name: '100.100,123' }, { id: 4, name: '100,100.123' }];
	var dateformats = [{ id: 'yyyy-MM-dd', name: '@(year-month-day)' }, { id: 'dd.MM.yyyy', name: '@(day.month.year)' }, { id: 'MM.dd.yyyy', name: '@(month.day.year)' }];

	OP.init(function(err, meta) {
		if (err) {
			document.body.innerHTML = '401: unauthorized';
			window.close();
		} else {
			resizelayout();
			userform_refresh(true);
		}
		OP.loading(false);
	});

	OP.on('maximize', function() {
		userform_refresh();
		NOTIFY('users.selected');
	});

	WATCH('users.filter', function(path) {
		if (path !== 'users.filter.page')
			users.filter.page = 1;
		setTimeout2('filter', userform_refresh, 200, null);
	});

	function usersform_load(item) {
		OP.loading(true);
		AJAX('GET /api/internal/users/{0}/'.format(item.id), function(response) {
			OP.loading(false, 1000);
			response.show = true;
			response.password = '*************';
			if (!response.dateformat)
				response.dateformat = 'yyyy-MM-dd';
			if (!response.timeformat)
				response.timeformat = 24;
			if (!response.numberformat)
				response.numberformat = 1;
			SET('users.form', response, true);
			if (!isMOBILE)
				FIND('#firstinput').find('input').focus();
		});
	}

	function userform_search(el, next) {
		SETTER('suggestion', 'show', 'left', el, function(search, next) {
			AJAX('GET /api/internal/users/', { q: search, directory: users.form.directory }, function(response) {
				users.form.id && (response.items = response.items.remove('id', users.form.id));
				next(response.items);
			});
		}, function(selected) {
			next(selected.id);
		});
	}

	function userform_refresh(meta, delay) {
		OP.loading2(true);
		AJAX('GET /api/internal/users/', users.filter, function(response) {
			OP.loading2(false);
			SET('users.response', response);
			SET('users.items', response.items);
		});

		if (meta === true) {
			setTimeout(function() {
				AJAX('GET /api/internal/meta/', 'users.meta');
			}, delay || 0);
			AJAX('GET /api/internal/apps/', function(response) {

				if (user.directory) {
					response.items = response.items.remove(function(app) {
						return app.directories && app.directories.length && app.directories.indexOf(user.directory) === -1;
					});
				}

				SET('users.apps', response);
			});
		}
	}

	function userform_filter(el) {
		var opt = {};
		opt.element = el;
		opt.width = 300;

		var items = opt.items = [];
		var makecl = function(type) {
			var arr = users.meta[type];
			var o = [];
			for (var i = 0; i < arr.length; i++)
				o.push(arr[i].name);
			return o;
		};

		items.push({ label: '@(Company)', placeholder: '@(All companies)', name: 'company', dirempty: '', type: makecl('companies') });
		items.push({ label: '@(Position)', placeholder: '@(All positions)', name: 'position', dirempty: '', type: makecl('positions') });
		items.push({ label: '@(Locality)', placeholder: '@(All localities)', name: 'locality', dirempty: '', type: makecl('localities') });
		items.push({ label: '@(Structure)', placeholder: '@(All organization units)', name: 'ou', dirempty: '', type: makecl('ou') });
		items.push({ label: '@(Gender)', placeholder: '@(All genders)', name: 'gender', dirempty: '', type: ['male', 'female'] });
		items.push({ label: '@(Language)', placeholder: '@(All languages)', name: 'language', dirempty: '', type: makecl('languages') });
		items.push({ label: '@(Group)', placeholder: '@(All groups)', name: 'group', dirempty: '', type: makecl('groups') });
		items.push({ label: '@(Role)', placeholder: '@(All roles)', name: 'role', dirempty: '', type: makecl('roles') });
		items.push({ label: '@(Status)', placeholder: '@(All statuses)', name: 'statusid', dirempty: '', type: [{ name: '@(Available)', id: 0 }, { name: '@(Busy)', id: 1 }, { name: '@(Do not disturb)', id: 2 }, { name: '@(Be right back)', id: 3 }, { name: '@(Meeting)', id: 4 }, { name: '@(Business trip)', id: 5 }, { name: '@(Holiday)', id: 6 }, { name: '@(Sick)', id: 7 }, { name: '@(Off work)', id: 8 }] });

		if (!user.directory)
			items.push({ label: '@(Directory)', placeholder: '@(Directories)', name: 'directory', dirempty: '@(All directories)', type: makecl('directories') });

		items.push({ label: '@(Group ID)', name: 'groupid', type: String, placeholder: '@(Type a group ID)' });
		items.push({ label: '@(Customers)', name: 'customer', type: Boolean });
		items.push({ label: '@(On-line)', name: 'online', type: Boolean });
		items.push({ label: '@(Super admin)', name: 'sa', type: Boolean });
		items.push({ label: '@(Inactive)', name: 'inactive', type: Boolean });
		items.push({ label: '@(Blocked)', name: 'blocked', type: Boolean });

		opt.value = users.filter;
		opt.offsetY = -5;
		opt.offsetX = -70;
		opt.align = 'left';
		opt.position = 'bottom';
		opt.clean = true;

		opt.callback = function(value, changed, keys, is) {
			SET('common.isfilter', is);
			userform_refresh();
		};

		SETTER('filter', 'show', opt);
	}

	function formscroll(value, path, el) {
		if (path === 'users.form') {
			setTimeout(function() {
				el.SETTER('scrollbar', 'scrollTop', 0);
			}, 10);
		}
	}

	function userform_generatepassword() {
		SET('users.form.password', GUID(10));
		CHANGE('users.form.password', true);
	}

	function userform_cancel() {
		SET('users.selected', '');
		SET('users.form.show', false);
	}

	function userform_generatetoken() {
		SET('users.form.accesstoken', GUID(40));
		CHANGE('users.form.accesstoken', true);
	}

	function userform_create() {
		SET('users.selected', '');
		SET('users.form', { language: 'en', numberformat: 1, timeformat: 24, dateformat: 'yyyy-MM-dd', show: true, id: '', directory: user.directory, accesstoken: GUID(40), email: '@', gender: 'male', rebuildtoken: true, sounds: true, dtbeg: NOW, notifications: true, notificationsemail: true, notificationsphone: true, welcome: true, volume: 80, apps: [], statusid: 0 }, true);
		if (!isMOBILE)
			FIND('#firstinput').find('input').focus();
	}

	function usersform_remove() {
		OP.confirm('@(Are you sure you want to remove selected user?)', ['"trash-o"@(Yes)', '@(Cancel)'], function(index) {
			if (!index) {
				var id = users.selected;
				AJAX('DELETE /api/internal/users/{0}/'.format(id), function(response) {
					if (response.success) {
						users.items = users.items.remove('id', id);
						users.form.id === id && userform_cancel();
						SET('users.selected', '');
						NOTIFY('users.items');
					}
				});
			}
		});
	}

	WATCH('users.form.company', function(path, value) {
		SET('%userssupervisors', users.items.findAll(function(item) {
			return value && item.company !== value ? false : item.id !== users.form.id;
		}));
	});

	function userform_submit() {

		OP.loading(true);
		var settings = {};

		// Collects app settings
		$('.userapp-settings-input').each(function() {
			if (this.value)
				settings[this.getAttribute('data-id')] = this.value;
		});

		var opt = {};

		// Check roles
		users.form.apps && Object.keys(users.form.apps).forEach(function(key) {
			var obj = users.form.apps[key];
			var app = users.apps.items.findItem('id', key);
			if (app) {
				opt[key] = { roles: obj.roles.remove(function(role) {
					return app.roles.indexOf(role) === -1;
				}), settings: settings[key] };
			}
		});

		var data = CLONE(users.form);
		data.apps = opt;

		AJAX('POST /api/internal/users/', data, function(response) {
			OP.loading(false);
			SET('users.form.response', response);
			if (response.success) {
				userform_refresh(true, 2000);
				userform_cancel();
				OP.success('@(Done, the user has been saved.)');
			}
		});
	}

	function browseroles(el) {
		var opt = {};
		opt.element = el;
		opt.items = users.meta.roles;

		for (var i = 0; i < opt.items.length; i++) {
			var item = opt.items[i];
			item.template = (!users.form.roles || users.form.roles.indexOf(item.id) === -1) ? '{{ name }}' : '<span class="silver">{{ name }}</span>';
		}

		opt.placeholder = '@(Search)';
		opt.callback = function(value) {
			if (!users.form.roles || users.form.roles.indexOf(value.id) === -1)
				PUSH2('users.form.roles', value.id);
		};
		SETTER('directory', 'show', opt);
	}

	function browsegroups(el) {
		var opt = {};
		opt.element = el;
		opt.items = users.meta.groups;

		for (var i = 0; i < opt.items.length; i++) {
			var item = opt.items[i];
			item.template = (!users.form.groups || users.form.groups.indexOf(item.id) === -1) ? '{{ name }}' : '<span class="silver">{{ name }}</span>';
		}

		opt.placeholder = '@(Search)';
		opt.callback = function(value) {
			if (!users.form.groups || users.form.groups.indexOf(value.id) === -1)
				PUSH2('users.form.group', value.id);
		};

		SETTER('directory', 'show', opt);
	}

	$('.scroller').on('scroll', function() {
		window.$calendar && window.$calendar.hide();
	});

	function users_pagination(value, path, el) {
		return value ? (el.attr('name') === 'prev' ? value.pages > 1 && value.page > 1 : value.pages > 1 && value.page < value.pages) : false;
	}

	function users_page(el) {
		SET('users.filter.page', el.attr('name') === 'prev' ? (users.filter.page - 1) : (users.filter.page + 1));
	}

	Thelpers.status = function(value, icon) {
		var str;
		switch (value) {
			case 1:
				str = 'spinner status1"></i>@(Busy)';
				break;
			case 2:
				str = 'moon status2"></i>@(Do not disturb)';
				break;
			case 3:
				str = 'door-open status3"></i>@(Be right back)';
				break;
			case 4:
				str = 'brain status4"></i>@(Meeting)';
				break;
			case 5:
				str = 'car status5"></i>@(Business trip)';
				break;
			case 6:
				str = 'umbrella-beach status6"></i>@(Holiday)';
				break;
			case 7:
				str = 'heartbeat status7"></i>@(Sick)';
				break;
			case 8:
				str = 'home status8"></i>@(Off work)';
				break;
			default:
				str = 'smile status0"></i>@(Available)';
				break;
		}

		var index = str.indexOf('</i>');
		var title = str.substring(index + 4);

		return '<i title="' + title + '" class="si fa fa-' + (icon ? str.substring(0, index + 4) : str);
	};
</script>